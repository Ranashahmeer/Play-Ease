<dx-popup
  [(visible)]="popupVisible"
  [showTitle]="false"
  [width]="600"
  [height]="'70vh'"
  [dragEnabled]="false"
>
  <div *dxTemplate="let data of 'content'" class="popup-content" style="padding: 0 15px 15px 15px;">
    <div class="popup-custom-header">
      <div class="popup-header-left">
        <h3 class="popup-court-name">{{ selectedCourt?.name ?? '' }}</h3>
        <div class="popup-subinfo">
          <span>{{ selectedCourt?.location }}</span>
          <span style="margin-left:8px;">• Rating: {{ selectedCourt?.rating }}</span>
        </div>
      </div>

      <button
        class="popup-close-btn"
        (click)="closePopup()"
        aria-label="Close popup"
        title="Close">
        ×
      </button>
    </div>

    <div style="padding: 12px 0 0 0;">
      <dx-gallery
        [dataSource]="galleryImages"
        [loop]="true"
        [showIndicator]="true"
        [height]="260"
        [stretchImages]="true"
        class="court-gallery">
      </dx-gallery>
    </div>

    <div class="popup-price-row" style="padding-top: 10px; display:flex; align-items:center; justify-content:space-between; gap:12px;">
      <p class="price-tag-popup">
        <strong>Booking price:</strong>
        <span style="font-weight:900; margin-left:6px;">Rs {{ getComputedPrice() }}</span>
        <small style="margin-left:8px; color:#666;">({{ form.get('matchDuration')?.value }} mins)</small>
      </p>
      <p class="hours-line-popup"><strong>Hours:</strong> {{ selectedCourt?.openingTime }} — {{ selectedCourt?.closingTime }}</p>
    </div>

    <div style="margin-top: 12px;">
      <label><strong>Match Duration</strong></label>
      <div class="popup-duration-buttons">
        <dx-button
          text="60 mins"
          [type]="form.get('matchDuration')?.value === 60 ? 'success' : 'default'"
          stylingMode="contained"
          (onClick)="setDuration(60)">
        </dx-button>

        <dx-button
          text="90 mins"
          [type]="form.get('matchDuration')?.value === 90 ? 'success' : 'default'"
          stylingMode="contained"
          (onClick)="setDuration(90)">
        </dx-button>

        <dx-button
          text="120 mins"
          [type]="form.get('matchDuration')?.value === 120 ? 'success' : 'default'"
          stylingMode="contained"
          (onClick)="setDuration(120)">
        </dx-button>
      </div>
    </div>

    <div style="margin-top: 10px;">
      <label><strong>Select Pitch Size:</strong></label>
      <div class="pitch-buttons-row">
        <dx-button
          *ngFor="let p of selectedCourt?.pitches || []"
          [text]="p.pitchtype"
          [type]="selectedPitchSize === p.pitchtype ? 'success' : 'default'"
          (onClick)="selectPitch(p)">
        </dx-button>
      </div>
    </div>

    <div style="margin-top: 12px;">
      <h4 style="margin: 8px 0 6px;">What we offer</h4>
      <div class="offers-row">
        <ng-container *ngIf="selectedCourt?.offers?.length; else noOffers">
          <span class="offer-chip" *ngFor="let off of selectedCourt?.offers">
            <span class="offer-icon" aria-hidden="true">{{ getOfferIcon(off) }}</span>
            <span class="offer-text">{{ off }}</span>
          </span>
        </ng-container>
        <ng-template #noOffers>
          <span style="color: #666; font-size: 13px;">No additional info available.</span>
        </ng-template>
      </div>
    </div>

    <div style="margin-top: 12px;">
      <h4 style="margin: 8px 0 6px;">About Us</h4>
      <p style="color: #444; line-height: 1.45;">
        {{ selectedCourt?.about ?? 'No description provided for this court.' }}
      </p>
    </div>

    <div style="margin-top: 6px;">
      <label><strong>Select Date:</strong></label>
      <dx-date-box
        [value]="selectedBookingDate"
        type="date"
        [min]="minDate"
        (onValueChanged)="onBookingDateChanged($event)">
      </dx-date-box>
    </div>

    <div style="margin-top: 10px;">
      <label style="display:block;"><strong>Select Time Slot:</strong></label>

      <dx-drop-down-box
        #ddBox
        [value]="selectedBookingTime"
        displayExpr="text"
        valueExpr="text"
        [dataSource]="timeSlotItems"
        [deferRendering]="false"
      >
        <div *dxTemplate="let dd of 'content'">
          <dx-list
            [dataSource]="timeSlotItems"
            selectionMode="single"
            displayExpr="text"
            (onItemClick)="onTimeItemClick($event, ddBox)"
          >
            <div *dxTemplate="let item of 'item'">
              <div [ngClass]="{'disabled-slot': item.disabled}">
                {{ item.text }}
              </div>
            </div>
          </dx-list>
        </div>
      </dx-drop-down-box>
    </div>

    <div *ngIf="bookedForDay.length > 0" style="margin-top: 6px; font-size: 12px; opacity: 0.8;">
      <em>Booked for {{ toKey(selectedBookingDate) }}:</em> {{ bookedForDay.join(', ') }}
    </div>
    <div *ngIf="allSlotsDisabled" style="margin-top: 6px; font-size: 13px; color: #d32f2f;">
      No time slots available for this date.
    </div>

    <div style="margin-top: 12px; padding-bottom: 12px;">
      <dx-button
        text="Review & Pay"
        type="success"
        stylingMode="contained"
        (onClick)="openPaymentReview()"
        style="width: 100%; background-color: #1a7f3a; color: white;">
      </dx-button>
    </div>
  </div>
</dx-popup>
