<div class="bookings-container">
  <!-- Sidebar Filters -->
  <aside class="filters">
    <form [formGroup]="form" (ngSubmit)="applyFilters()">
      <h3>FILTER BY</h3>

      <label>Date</label>
      <dx-date-box
        formControlName="selectedDate"
        type="date"
        [min]="minDate"
        (onValueChanged)="recomputeSidebarTimeOptions()">
      </dx-date-box>

      <label>Choose Your Time</label>
      <dx-drop-down-box
        #sidebarTimeBox
        formControlName="selectedTime"
        displayExpr="text"
        valueExpr="text"
        [dataSource]="timeOptionsSidebar"
        [deferRendering]="false"
      >
        <div *dxTemplate="let dd of 'content'">
          <dx-list
            [dataSource]="timeOptionsSidebar"
            displayExpr="text"
            selectionMode="single"
            (onItemClick)="onSidebarTimeSelect($event, sidebarTimeBox)">
            <div *dxTemplate="let item of 'item'">
              <div>
                {{ item.text }}
              </div>
            </div>
          </dx-list>
        </div>
      </dx-drop-down-box>

      <label>Match Duration</label>
      <div class="duration-buttons">
        <dx-button
          text="60 mins"
          [type]="form.get('matchDuration')?.value === 60 ? 'success' : 'default'"
          stylingMode="contained"
          (onClick)="setDuration(60)">
        </dx-button>

        <dx-button
          text="90 mins"
          [type]="form.get('matchDuration')?.value === 90 ? 'success' : 'default'"
          stylingMode="contained"
          (onClick)="setDuration(90)">
        </dx-button>

        <dx-button
          text="120 mins"
          [type]="form.get('matchDuration')?.value === 120 ? 'success' : 'default'"
          stylingMode="contained"
          (onClick)="setDuration(120)">
        </dx-button>
      </div>

      <label>Pitch Size</label>
      <dx-tag-box
        [items]="['5x5', '6x6', '7x7', '9x9', '11x11']"
        formControlName="selectedPitchSizes"
        [showSelectionControls]="true">
      </dx-tag-box>

      <label>Distance (km)</label>
      <dx-slider formControlName="distance" [min]="0" [max]="50"></dx-slider>

      <dx-button text="Use Current Location" (onClick)="useCurrentLocation()"></dx-button>

      <div class="action-buttons">
        <dx-button text="Clear" (onClick)="clearFilters()"></dx-button>
        <dx-button text="Filter" type="default" [useSubmitBehavior]="true"></dx-button>
      </div>
    </form>
  </aside>

  <!-- Court Cards -->
  <main class="courts-area">
    <!-- <div class="search-bar" [formGroup]="form">
      <input type="text" formControlName="searchQuery" placeholder="Search for a stadium, facility, or class..." />
      <button type="button" (click)="updateVisibleCourts()">Search</button>
    </div> -->

    <div *ngIf="noCourtsMessage && manualFilteredCourts.length === 0" class="no-courts-message">
      {{ noCourtsMessage }}
    </div>

    <div *ngIf="!noCourtsMessage && visibleCourts.length === 0" class="no-courts-message">
      No courts found. Try changing filters or clearing them.
    </div>

    <div class="court-card" *ngFor="let court of visibleCourts" (click)="openCourtDetails(court)">
      <img [src]="court.image" alt="Court Image" />
      <div class="info">
        <h4>{{ court.name }}</h4>
        <p>{{ court.location }}</p>
        <p>Rating: {{ court.rating }}</p>
        <p>Pitches: {{ court.pitches.length }}</p>
        <p class="price-tag">Booking price: Rs {{ getCourtMinPrice(court) }}</p>
        <p class="hours-line"><strong>Hours:</strong> {{ court.openingTime }} — {{ court.closingTime }}</p>
      </div>
    </div>

    <div style="display: flex; gap: 10px; margin-top: 20px;">
      <button class="next-button" (click)="prevPage()" *ngIf="currentPage > 1">Previous</button>
      <button class="next-button" (click)="nextPage()" *ngIf="hasNextPage()">Next</button>
    </div>
  </main>
</div>

<!-- Booking details popup (existing) -->
<dx-popup
  [(visible)]="popupVisible"
  [showTitle]="false"
  [width]="600"
  [height]="'70vh'"
  [dragEnabled]="false"
>
  <div *dxTemplate="let data of 'content'" class="popup-content" style="padding: 0 15px 15px 15px;">
    <div class="popup-custom-header">
      <div class="popup-header-left">
        <h3 class="popup-court-name">{{ selectedCourt?.name ?? '' }}</h3>
        <div class="popup-subinfo">
          <span>{{ selectedCourt?.location }}</span>
          <span style="margin-left:8px;">• Rating: {{ selectedCourt?.rating }}</span>
        </div>
      </div>

      <button
        class="popup-close-btn"
        (click)="popupVisible = false"
        aria-label="Close popup"
        title="Close">
        ×
      </button>
    </div>

    <div style="padding: 12px 0 0 0;">
      <dx-gallery
        [dataSource]="galleryImages"
        [loop]="true"
        [showIndicator]="true"
        [height]="260"
        [stretchImages]="true"
        class="court-gallery">
      </dx-gallery>
    </div>

    <div class="popup-price-row" style="padding-top: 10px; display:flex; align-items:center; justify-content:space-between; gap:12px;">
      <p class="price-tag-popup">
        <strong>Booking price:</strong>
        <span style="font-weight:900; margin-left:6px;">Rs {{ getComputedPrice() }}</span>
        <small style="margin-left:8px; color:#666;">({{ form.get('matchDuration')?.value }} mins)</small>
      </p>
      <p class="hours-line-popup"><strong>Hours:</strong> {{ selectedCourt?.openingTime }} — {{ selectedCourt?.closingTime }}</p>
    </div>

    <div style="margin-top: 12px;">
      <label><strong>Match Duration</strong></label>
      <div class="popup-duration-buttons">
        <dx-button
          text="60 mins"
          [type]="form.get('matchDuration')?.value === 60 ? 'success' : 'default'"
          stylingMode="contained"
          (onClick)="setDuration(60)">
        </dx-button>

        <dx-button
          text="90 mins"
          [type]="form.get('matchDuration')?.value === 90 ? 'success' : 'default'"
          stylingMode="contained"
          (onClick)="setDuration(90)">
        </dx-button>

        <dx-button
          text="120 mins"
          [type]="form.get('matchDuration')?.value === 120 ? 'success' : 'default'"
          stylingMode="contained"
          (onClick)="setDuration(120)">
        </dx-button>
      </div>
    </div>

    <div style="margin-top: 10px;">
      <label><strong>Select Pitch Size:</strong></label>
      <div class="pitch-buttons-row">
        <dx-button
        *ngFor="let p of selectedCourt?.pitches || []"
        [text]="p.pitchtype"
        [type]="selectedPitchSize === p.pitchtype ? 'success' : 'default'"
        (onClick)="selectPitch(p)">
      </dx-button>
      </div>
    </div>
    

    <div style="margin-top: 12px;">
      <h4 style="margin: 8px 0 6px;">What we offer</h4>
      <div class="offers-row">
        <ng-container *ngIf="selectedCourt?.offers?.length; else noOffers">
          <span class="offer-chip" *ngFor="let off of selectedCourt?.offers">
            <span class="offer-icon" aria-hidden="true">{{ getOfferIcon(off) }}</span>
            <span class="offer-text">{{ off }}</span>
          </span>
        </ng-container>
        <ng-template #noOffers>
          <span style="color: #666; font-size: 13px;">No additional info available.</span>
        </ng-template>
      </div>
    </div>

    <div style="margin-top: 12px;">
      <h4 style="margin: 8px 0 6px;">About Us</h4>
      <p style="color: #444; line-height: 1.45;">
        {{ selectedCourt?.about ?? 'No description provided for this court.' }}
      </p>
    </div>

    <div style="margin-top: 6px;">
      <label><strong>Select Date:</strong></label>
      <dx-date-box
        [value]="selectedBookingDate"
        type="date"
        [min]="minDate"
        (onValueChanged)="onBookingDateChanged($event)">
      </dx-date-box>
    </div>

    <div style="margin-top: 10px;">
      <label style="display:block;"><strong>Select Time Slot:</strong></label>

      <dx-drop-down-box
        #ddBox
        [value]="selectedBookingTime"
        displayExpr="text"
        valueExpr="text"
        [dataSource]="timeSlotItems"
        [deferRendering]="false"
      >
        <div *dxTemplate="let dd of 'content'">
          <dx-list
            [dataSource]="timeSlotItems"
            selectionMode="single"
            displayExpr="text"
            (onItemClick)="onTimeItemClick($event, ddBox)"
          >
            <div *dxTemplate="let item of 'item'">
              <div [ngClass]="{'disabled-slot': item.disabled}">
                {{ item.text }}
              </div>
            </div>
          </dx-list>
        </div>
      </dx-drop-down-box>
    </div>

    <div *ngIf="bookedForDay.length > 0" style="margin-top: 6px; font-size: 12px; opacity: 0.8;">
      <em>Booked for {{ toKey(selectedBookingDate) }}:</em> {{ bookedForDay.join(', ') }}
    </div>
    <div *ngIf="allSlotsDisabled" style="margin-top: 6px; font-size: 13px; color: #d32f2f;">
      No time slots available for this date.
    </div>

    <!-- REVIEW & PAY button (changed label and handler) -->
    <div style="margin-top: 12px; padding-bottom: 12px;">
      <dx-button
        text="Review & Pay"
        type="success"
        stylingMode="contained"
        (onClick)="openPaymentReview()"
        style="width: 100%; background-color: #1a7f3a; color: white;">
      </dx-button>
    </div>
  </div>
</dx-popup>

<!-- Payment Review popup (updated header + reservation timer + back arrow) -->
<dx-popup
  [(visible)]="paymentPopupVisible"
  [showTitle]="false"
  [width]="520"
  [height]="'auto'"
  [dragEnabled]="false"
>
  <div *dxTemplate="let data of 'content'">
    <!-- Custom header with green stripe and back-arrow -->
    <div class="payment-header">
      <button class="back-arrow" (click)="goBackToBooking()" title="Back to booking">◀</button>
      <div class="payment-title">
        <div class="payment-title-text">Payment Review</div>
        <div class="reservation-line" *ngIf="reservationExpiresAt && !reservationExpired">
          <small>Reservation active — pay within <strong>{{ reservationRemaining }}</strong></small>
        </div>
        <div class="reservation-expired" *ngIf="reservationExpired">
          <small style="color:#b00020">Reservation expired — please go back and re-select slots.</small>
        </div>
      </div>
    </div>

    <div style="padding: 16px; max-height: 75vh; overflow:auto;">
      <h4>Bill Summary</h4>
      <div class="bill-row"><strong>Court:</strong> {{ selectedCourt?.name }}</div>
      <div class="bill-row"><strong>Pitch:</strong> {{ selectedPitchSize }}</div>
      <div class="bill-row"><strong>Date:</strong> {{ toKey(selectedBookingDate) }}</div>
      <div class="bill-row"><strong>Time:</strong> {{ selectedBookingTime }}</div>
      <div class="bill-row"><strong>Duration:</strong> {{ form.get('matchDuration')?.value }} mins</div>
      <div class="bill-row"><strong>Amount:</strong> Rs {{ getComputedPrice() }}</div>

      <hr>

      <h4>Payment Options</h4>

      <div class="payment-method">
        <div *ngIf="ownerPaymentMethods?.length">
          <h3 class="font-bold">Payment Methods</h3>
          <div *ngFor="let method of ownerPaymentMethods" class="mb-2">
            <p><strong>{{ method.MethodName }}</strong></p>
            <p>Account Title: {{ method.AccountTitle }}</p>
            <p>Account Number: {{ method.AccountNumber }}</p>
            <p *ngIf="method.BankName">Bank: {{ method.BankName }}</p>
            <hr>
          </div>
        </div>
      </div>

      <hr>

      <h4 style="margin-bottom:6px;">Upload Payment Proof (JPG / PNG) *</h4>
      <ng-container *ngIf="isBrowser">
      <dx-file-uploader
        [accept]="'image/png,image/jpeg'"
        [multiple]="false"
        (onValueChanged)="onFileUpload($event)">
      </dx-file-uploader>
    </ng-container>
      <div *ngIf="paymentProofPreviewUrl" style="margin-top:10px;">
        <p style="margin:4px 0 6px;"><strong>Preview</strong></p>
        <img [src]="paymentProofPreviewUrl" alt="payment proof" style="max-width:100%; border-radius:6px; border:1px solid #eee;">
      </div>

      <div style="display:flex; gap:8px; margin-top:14px;">
        <dx-button text="Cancel" (onClick)="paymentPopupVisible = false; stopReservationTimer()"></dx-button>
        <dx-button text="Submit Payment Proof" type="success" stylingMode="contained"
          (onClick)="submitPaymentProof()"
          [disabled]="!paymentProofFile || reservationExpired">
        </dx-button>
      </div>
    </div>
  </div>
</dx-popup>
