<section class="my-requests-section">
  <h2 class="section-title">My Requests</h2>
  <p class="section-subtitle">Manage your posted requests and view accepted applications</p>

  <div id="myRequestsList">
    <article 
      class="request-card" 
      *ngFor="let request of requests"
      [attr.data-match-date]="request.date"
      [attr.data-match-time]="request.endTime">
      <header class="request-header">
        <h3 class="request-title">{{ request.title }}</h3>
        <div class="request-badges">
          <span class="request-badge" *ngIf="isOwnRequest(request)">
            {{ getRemainingSlots(request) }} Slot{{ getRemainingSlots(request) !== 1 ? 's' : '' }} Left
          </span>
          <span class="request-badge" style="background-color: #28a745;" *ngIf="isOwnRequest(request) && getRemainingSlots(request) === 0">
            Fully Booked ✓
          </span>
          <span class="accepted-badge" *ngIf="isAcceptedApplicant(request)">✓ Accepted</span>
        </div>
      </header>
      
      <!-- Show organizer info for accepted applications -->
      <div class="organizer-info" *ngIf="isAcceptedApplicant(request) && !isOwnRequest(request)">
        <span class="organizer-label">Organizer:</span>
        <span class="organizer-name">{{ request.organizer }}</span>
        <span class="organizer-label" style="margin-left: 16px;">Your Role:</span>
        <span class="organizer-name">{{ getMyApplicantInfo(request)?.role }}</span>
      </div>
      
      <!-- Show accepted applicants info for organizer -->
      <div class="accepted-applicants-info" *ngIf="isOwnRequest(request) && hasAcceptedApplicants(request)">
        <div class="info-header">
          <span class="info-label">✓ Accepted Players:</span>
        </div>
        <div class="accepted-players-list">
          <div class="player-tag" *ngFor="let applicant of getAcceptedApplicants(request)">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M20 6L9 17l-5-5"></path>
            </svg>
            <span class="player-name">{{ applicant.userName }}</span>
            <span class="player-role">({{ applicant.role }})</span>
          </div>
        </div>
      </div>
      <div class="request-details">
        <div class="detail-item">
          <svg class="icon" viewBox="0 0 24 24">
            <path d="M19 4h-1V2h-2v2H8V2H6v2H5a2 2 0 00-2 2v12a2 2 0 002 2h14a2 2 0 002-2V6a2 2 0 00-2-2zm0 14H5V10h14z" fill="currentColor"></path>
          </svg>
          {{ formatDate(request.date) }}
        </div>
        <div class="detail-item">
          <svg class="icon" viewBox="0 0 24 24">
            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none"></circle>
            <path d="M12 6v6l4 2" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"></path>
          </svg>
          {{ formatTime(request.startTime) }} - {{ formatTime(request.endTime) }}
        </div>
        <div class="detail-item">
          <svg class="icon" viewBox="0 0 24 24">
            <path d="M12 2a7 7 0 017 7c0 5-7 13-7 13S5 14 5 9a7 7 0 017-7z" fill="currentColor"></path>
          </svg>
          {{ request.location }}
        </div>
        <div class="detail-item">
          <svg class="icon" viewBox="0 0 24 24">
            <path d="M12 2a5 5 0 1 1-5 5 5 5 0 0 1 5-5Zm0 9a9 9 0 0 1 9 9v1H3v-1a9 9 0 0 1 9-9Z" fill="currentColor"></path>
          </svg>
          {{ request.roles }}
        </div>
        <div class="detail-item">
          <svg class="icon" viewBox="0 0 24 24">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1.41 16.09V20h-2.67v-1.93c-1.71-.36-3.16-1.46-3.27-3.4h1.96c.1 1.05.82 1.87 2.65 1.87 1.96 0 2.4-.98 2.4-1.59 0-.83-.44-1.61-2.67-2.14-2.48-.6-4.18-1.62-4.18-3.67 0-1.72 1.39-2.84 3.11-3.21V4h2.67v1.95c1.86.45 2.79 1.86 2.85 3.39H14.3c-.05-1.11-.64-1.87-2.22-1.87-1.5 0-2.4.68-2.4 1.64 0 .84.65 1.39 2.67 1.91s4.18 1.39 4.18 3.91c-.01 1.83-1.38 2.83-3.12 3.16z" fill="currentColor"></path>
          </svg>
          PKR {{ request.price }}
        </div>
      </div>

      <!-- Chat button for accepted applicants -->
      <div class="accepted-actions" *ngIf="isAcceptedApplicant(request) && !isOwnRequest(request)">
        <div class="match-info-text">
          <p><strong>Your application has been accepted!</strong></p>
          <p>Match is scheduled for {{ formatDate(request.date) }} from {{ formatTime(request.startTime) }} to {{ formatTime(request.endTime) }}</p>
        </div>
        <button 
          class="btn-chat-organizer"
          [class.active]="isChatAvailableWithOrganizer(request)"
          [disabled]="!isChatAvailableWithOrganizer(request)"
          (click)="startChatWithOrganizer(request)"
          [title]="!isChatAvailableWithOrganizer(request) ? 'Chat only available until match ends' : 'Chat with organizer'">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
          </svg>
          Chat with Organizer
        </button>
      </div>

      <!-- Applicants list (only for own requests) -->
      <div class="applicants-list" *ngIf="isOwnRequest(request) && request.applicants && request.applicants.length > 0">
        <div class="applicant-item" *ngFor="let applicant of request.applicants" [class.status-pending]="applicant.status === 'pending'" [class.status-accepted]="applicant.status === 'accepted'" [class.status-rejected]="applicant.status === 'rejected'">
          <div class="applicant-info">
            <div class="applicant-header">
              <span class="applicant-name">{{ applicant.userName }}</span>
              <span class="status-badge" [class.badge-pending]="applicant.status === 'pending'" [class.badge-accepted]="applicant.status === 'accepted'" [class.badge-rejected]="applicant.status === 'rejected'">
                {{ applicant.status === 'pending' ? 'Pending' : applicant.status === 'accepted' ? 'Accepted' : 'Rejected' }}
              </span>
            </div>
            <span class="applicant-position">{{ applicant.role }}</span>
          </div>
          <div class="applicant-actions">
            <button 
              class="btn-accept"
              [class.accepted]="applicant.status === 'accepted'"
              [disabled]="applicant.status !== 'pending'"
              [disabled]="applicant.status === 'accepted' || isFullyBooked(request)"
              (click)="acceptApplicant(request, applicant)"
              [title]="isFullyBooked(request) ? 'Request is fully booked' : (applicant.status === 'accepted' ? 'Already accepted' : 'Accept applicant')">
              {{ applicant.status === 'accepted' ? 'Accepted' : 'Accept' }}
            </button>
            <button 
              class="btn-reject"
              [class.rejected]="applicant.status === 'rejected'"
              [disabled]="applicant.status !== 'pending'"
              (click)="rejectApplicant(request, applicant)">
              {{ applicant.status === 'rejected' ? 'Rejected' : 'Reject' }}
            </button>
            <button 
              class="btn-chat"
              [class.active]="applicant.status === 'accepted' && isChatAvailable(request, applicant)"
              [disabled]="!isChatAvailable(request, applicant)"
              (click)="startChat(request, applicant)"
              [title]="!isChatAvailable(request, applicant) ? 'Chat only available for accepted applicants until match ends' : 'Start chat'">
              Chat
            </button>
          </div>
        </div>
      </div>
    </article>

    <div class="empty-state" *ngIf="requests.length === 0">
      <p>You haven't posted any match requests yet.</p>
      <p>You also don't have any accepted applications.</p>
    </div>
  </div>
</section>

<!-- Chat Popup -->
<div class="chat-popup" [class.active]="showChat" *ngIf="currentChatRequest">
  <div class="chat-header">
    <div class="chat-header-info">
      <div class="chat-participant-name" *ngIf="currentChatApplicant">Chat with {{ currentChatApplicant.userName }}</div>
      <div class="chat-participant-name" *ngIf="!currentChatApplicant">Chat with {{ currentChatRequest.organizer }}</div>
      <div class="chat-match-info">{{ currentChatRequest.title }}<span *ngIf="currentChatApplicant"> - {{ currentChatApplicant.role }}</span></div>
    </div>
    <button class="btn-close" (click)="closeChat()" aria-label="Close chat">&times;</button>
  </div>
  <div class="chat-messages" #chatMessagesContainer>
    <div 
      class="chat-message"
      [class.my-message]="isMyMessage(message)"
      [class.their-message]="!isMyMessage(message)"
      *ngFor="let message of chatMessages">
      <div class="message-sender">{{ message.senderName }}</div>
      <div class="message-text">{{ message.message }}</div>
      <div class="message-time">{{ formatMessageTime(message.timestamp || message.createdAt) }}</div>
    </div>
    <div class="chat-empty" *ngIf="chatMessages.length === 0">
      No messages yet. Start the conversation!
    </div>
  </div>
  <div class="chat-input">
    <input 
      [(ngModel)]="chatInput"
      (keypress)="handleChatKeyPress($event)"
      placeholder="Type a message..."
      [disabled]="(currentChatApplicant && !isChatAvailable(currentChatRequest, currentChatApplicant)) || (!currentChatApplicant && !isChatAvailableWithOrganizer(currentChatRequest))"/>
    <button 
      class="chat-send-btn" 
      (click)="sendMessage()"
      [disabled]="!chatInput.trim() || (currentChatApplicant && !isChatAvailable(currentChatRequest, currentChatApplicant)) || (!currentChatApplicant && !isChatAvailableWithOrganizer(currentChatRequest))">
      Send
    </button>
  </div>
  <div class="chat-status" *ngIf="(currentChatApplicant && !isChatAvailable(currentChatRequest, currentChatApplicant)) || (!currentChatApplicant && !isChatAvailableWithOrganizer(currentChatRequest))">
    Chat is no longer available. The match has ended.
  </div>
</div>